<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>VoiceMap 소셜 로그인 테스트</title>
  <!-- Tailwind CSS 로드 -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Google GSI (Sign In) 라이브러리 로드 -->
  <script src="https://accounts.google.com/gsi/client" async defer></script>
  <style>
    /* Inter 폰트 적용 (Tailwind 기본) */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
    body {
      font-family: 'Inter', sans-serif;
    }
    /* pre 태그 줄바꿈 스타일 */
    pre {
      white-space: pre-wrap;       /* CSS 3 */
      white-space: -moz-pre-wrap;  /* Mozilla, since 1999 */
      white-space: -pre-wrap;      /* Opera 4-6 */
      white-space: -o-pre-wrap;    /* Opera 7 */
      word-wrap: break-word;       /* Internet Explorer 5.5+ */
    }
    /* 기본 hidden 클래스 */
    .hidden {
      display: none;
    }
  </style>
</head>
<body class="flex items-center justify-center min-h-screen bg-gray-100">

<div class="bg-white p-8 rounded-2xl shadow-xl w-full max-w-md">
  <h1 class="text-2xl font-bold text-center text-gray-800 mb-2">
    VoiceMap 로그인
  </h1>
  <p class="text-sm text-center text-gray-500 mb-6">
    Google 계정으로 시작하세요.
  </p>

  <!-- 1. Google 로그인 버튼 섹션 -->
  <div id="google-signin-container" class="flex justify-center mb-4">
    <!--
        이 div는 Google GSI 라이브러리가 로드될 때 Google 로그인 버튼으로 대체됩니다.
        data-callback="handleGoogleSignIn" : 성공 시 호출할 JS 함수
    -->
    <div id="g_id_onload"
         data-client_id="576841251015-37rqgu2q123le96gt6t4sgv98udtqmrv.apps.googleusercontent.com"
         data-callback="handleGoogleSignIn"
         data-context="signin"
         data-ux_mode="popup"
         data-login_uri=""
         data-auto_prompt="false">
    </div>

    <div class="g_id_signin"
         data-type="standard"
         data-shape="rectangular"
         data-theme="outline"
         data-text="continue_with"
         data-size="large"
         data-logo_alignment="left">
    </div>
  </div>

  <!-- 2. 토큰 획득 후 회원가입/로그인 버튼 섹션 (처음에는 숨김) -->
  <div id="token-actions-container" class="hidden">
    <p class="text-sm text-center text-green-600 font-semibold mb-4">
      ✅ Google ID 토큰 획득 완료!
    </p>
    <div class="flex flex-col space-y-3">
      <button id="register-button" class="w-full py-3 px-4 rounded-lg text-white font-semibold bg-green-600 hover:bg-green-700 transition-all shadow-md">
        이 계정으로 회원가입
      </button>
      <button id="login-button" class="w-full py-3 px-4 rounded-lg text-white font-semibold bg-blue-600 hover:bg-blue-700 transition-all shadow-md">
        이 계정으로 로그인
      </button>
    </div>
  </div>

  <!-- 3. 결과 표시 영역 -->
  <div id="result-container" class="mt-6">
    <p id="message" class="text-center text-sm font-medium mb-3"></p>
    <label class="block text-xs font-semibold text-gray-500 mb-1">서버 응답:</label>
    <pre id="response" class="bg-gray-900 text-white text-xs p-4 rounded-lg overflow-x-auto"></pre>
  </div>
</div>

<script>
  // 전역 변수로 Google ID 토큰 저장
  let googleIdToken = null;

  // UI 요소 캐싱
  const googleSigninContainer = document.getElementById('google-signin-container');
  const tokenActionsContainer = document.getElementById('token-actions-container');
  const registerButton = document.getElementById('register-button');
  const loginButton = document.getElementById('login-button');
  const messageEl = document.getElementById('message');
  const responseEl = document.getElementById('response');

  /**
   * 1. Google 로그인이 성공했을 때 GSI 라이브러리에 의해 호출되는 콜백 함수
   */
  function handleGoogleSignIn(credentialResponse) {
    console.log("Google Sign-In response:", credentialResponse);

    // JWT 형태의 ID 토큰
    googleIdToken = credentialResponse.credential;

    if (googleIdToken) {
      // UI 상태 변경
      googleSigninContainer.classList.add('hidden');
      tokenActionsContainer.classList.remove('hidden');

      // 메시지 업데이트
      showMessage('Google ID 토큰이 성공적으로 발급되었습니다. 회원가입 또는 로그인을 선택하세요.', 'success');
      responseEl.textContent = `[Google ID Token (일부)]\n${googleIdToken.substring(0, 50)}...`;
    } else {
      showMessage('Google 로그인에 실패했습니다.', 'error');
    }
  }

  /**
   * 2. '회원가입' 또는 '로그인' 버튼 클릭 시 백엔드 API 호출
   * @param {string} action - 'register' 또는 'login'
   */
  async function sendTokenToBackend(action) {
    if (!googleIdToken) {
      showMessage('Google ID 토큰이 없습니다. 먼저 Google 로그인을 해주세요.', 'error');
      return;
    }

    const provider = 'google'; // API 경로에 포함될 provider
    const url = `http://localhost:8080/test/auth/${provider}/${action}`;

    // 로딩 메시지
    showMessage(`${action} 요청 중...`, 'loading');
    responseEl.textContent = '';

    try {
      const response = await fetch(url, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({ idToken: googleIdToken })
      });

      // 응답이 JSON인지 텍스트(에러)인지 확인
      const contentType = response.headers.get("content-type");

      if (response.ok) {
        // 성공 (200 OK 또는 201 Created)
        const data = await response.json();
        console.log('Backend Success:', data);
        showMessage(`[${action}] 성공! 앱 토큰이 발급되었습니다.`, 'success');
        responseEl.textContent = JSON.stringify(data, null, 2);

      } else {
        // 실패 (400 Bad Request 등)
        // 백엔드에서 AuthException이 발생하면 텍스트로 에러 메시지가 옴
        const errorText = await response.text();
        console.error('Backend Error:', errorText);
        showMessage(`[${action}] 실패: ${errorText}`, 'error');
        responseEl.textContent = `HTTP Status: ${response.status}\nError: ${errorText}`;
      }
    } catch (error) {
      // 네트워크 에러 (CORS, 서버 미실행 등)
      console.error('Network Error:', error);
      showMessage(`네트워크 오류가 발생했습니다. (서버 실행 확인 및 CORS 설정 확인)\n${error.message}`, 'error');
      responseEl.textContent = error.toString();
    }
  }

  /**
   * 3. 메시지 영역 헬퍼 함수
   */
  function showMessage(msg, type = 'info') {
    messageEl.textContent = msg;
    messageEl.classList.remove('text-green-600', 'text-red-600', 'text-gray-600');

    if (type === 'success') {
      messageEl.classList.add('text-green-600');
    } else if (type === 'error') {
      messageEl.classList.add('text-red-600');
    } else {
      messageEl.classList.add('text-gray-600');
    }
  }

  // --- DOM 로드 후 이벤트 리스너 등록 ---
  document.addEventListener('DOMContentLoaded', () => {
    registerButton.addEventListener('click', () => sendTokenToBackend('register'));
    loginButton.addEventListener('click', () => sendTokenToBackend('login'));
  });

</script>
</body>
</html>